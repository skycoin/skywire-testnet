package conn

import (
	"encoding/binary"
	"encoding/hex"
	"testing"

	"github.com/skycoin/skywire/pkg/net/msg"
)

func TestFec(t *testing.T) {
	ds := 4
	ps := 1
	decoder := newFECDecoder(ds, ps)

	//b1, _ := hex.DecodeString("01000005470000044cafee80040b9555abdd8e51fb9ebb0323befe04f0eab1e7567f3bcd7f2547d91dcbc1b0e3ceeb0e77f5a5cf228793f3833f906abbf2ababf67da178d9807b228ee6ec1a0fb2456dd90459b6d1e724048c935dd0761cca95a0a2d48f686eea695e72ad66786feb1f75e087728214f8dd50db76b9015993fa18e6b0fea544caf8a93a42d2c9c1bbf18e60aab91c4741f6ffee1d6b38928771c5f665a908c8c3fcd043096651e0878d54877d3f658a2ce5d07fb611801e885f2e62bfa6ed12e9b47ef6d1536310f43b098dcfdfce1dc8720ffb11a8a485713cffc425b93912262fc21ee127877b70ad7c5b2f4784c9345269e517eb2e02ace9b77580ddfd830dddfdd023731557cade0c8f65bddca2fc0913211128d7bed4c5661cb66e4d59698394e94117ec070dd630c3e308deba87a687411db929b9b302f7f1ad06ed70874328cf407d03327bcdc28d620315ec72a40f76d8ecc25d52d1af10650e0e46256abfda4c83e49a036629336fce6b0706ea3c7f11e15da04f49b349a41647f456cafaa1adbbf3da1310bf9626c017c05a4c16b76679efca6624347f0b4005fa151e3962c38abec5a0e8f84dfe5e8985765de7023dcf6cc349da49400f9add7466e47a2da7b7ea84bfc670dcfa7645b4c5d7802b6e1f58fe022e79992426c15052bb6670bcf33d00bc9ede8820d0782361f8a7b47c52577613f68f1c7703483f6b1d86bf96d00a34a05ef4b3c4c19672cd80fa417b7ba3cf64951f583c048763deeba343f0188b981cdf00aa94574889a66d99cd4d5057a5cc70183d29dcbc1ce5c3be52271d05a87970d16b6b5a8ccfa5a6fe8fd4941366c3f9407320b0e752645f32d245f5bf04f0332ab0d90c8f993551f6071a0e6a8797bae631f5ec18ebb5eaf831b0698bd3279c8b324f0cf9bd51c122281c3fccf6b1f759169f3cc1703e7f417f472020d3a91e6d2ea9bff36770fda8c37352359ab2b6b63180d04305d4752d895944f8c23921d0172ca07ec8edfd3f171edf7f75a63fd1d1640151beabd151416f69db2957259e7251dfc356cbb8953896a229dbd131a64f071d8c2e8206b02c99d2b5efe219e4fe9ec2d11268b5797c42697fbf2f23c8a0e69684176123540080033f7451d2fed096ff4986cf278610db0a6af5648a1d6563f540ed9a935178d9f6b430457aa4a472d882ea1a3d4f262a7f3444c6cc522560f4ef2642e2902c67343eba23495d9aafc02182bf446068339c99d42f549cd6d2b23310afab7083348383278b6adff8a1ed3d0e277e7703da54586e2569873e20693edb16d63ac55743b9e0ea9e9f072c4c91fcc74c2a70692739676e0234f21c4197447e23fee7c53992c08d889bbbb5f7852a2bf31f0736a4d608b67fe4e03ea92ced9ef6f1572ba00db7284a8b62f47726812f03a561d5b8d733487c74a38b7303dff28e34d81b6b6e8074981a1771b67dbb3f0c1e529e26933f127d74f7a4ce70122dff8dc4c11b5b0de7f1ddcd960eebfb13960104c29ae454a5887b31fbac23a5af619760a3534be0f6f1e8a21e8b5c")
	//b2, _ := hex.DecodeString("01000005480000044ca8c03e405b3d89d2e1e090be153d977c3716d6c34aaa632e24d02d56b6777cddbf1fed7dccfaca669a1056653c122d08ce018603b2fb131cfb4c6a5b890061fd12ab14f3b0d9b49db055c25aa31aebf0ba3f873d09fe10cca9b9833ffe0d6a201716ae087dcf841cdc0c4b17e58455ea92bdac26b92f9f0e979a5124c3fef2db6f1ce790c4c5df4202b70321d4afb063383cf368372b861309e2b1701fde0468c00a981115cd929ab2d21a3507e8143abb94408e8d907f6cf6f6895db586b742a12731f8e961421c74d5013f00bd9533301502d5c1f972bcdfc4a91340a464eecf86b3311812d6b2846fe26eb4e6a2f724e85fe5bc093f966592a4f32bc50bfe06a64c5ca755d67d5a014a2b377cdf902d90b49dff2d3ed1082eacb26c860d6644a3875a4ea1028bcafe7f4df0ca11bd278994c6b0526931124ee0bdfa11527a4b58ebb70ea5d0235fe0628bd12469b27f4d238279d10c21d367e98b30e49308548e9edd92a1ed2e5ba367d703cb1d1297bb34f35f20f9cf5f2c3d09e14588b0d31418835f1992fa08894e21eb7c6422de6868bb29a33cf911fccbed664f5295e7a03db201c2ef1a359ff87a52786470c09e1b7330d239cc1701717bc7cacdf0f0fed9109eebc1e6ab8ed274fe19afd7d89a8b73a20f7dea5f175266d1e19b544e569573bca85a7eb5798a1849d10428be540520e3751c449005f5f2d3710c05fc302ed467d08e9161fc204c21e3e1e1959e0d2c4f0e33184a743327a9fd0965b135bd055ff994bb9b76ffc2498ec5405f4534a80d70a910c86cd16bf6d1e111633a0aefab4b729f98aa0a5e095fa08b09432112fafc2a1ff4efa9a472683f903dab9c1572691b18cdeee6006ec2d5d09d1d8a0d0051124d939f5596b08f697ac2e85a9f3e8bcbf6eb314f671144c9c9ce61980bae850c90cc653c047e83603f7cd4a19adffae97623bc0635f1772163618742fb076cb07dc2006cf4e81bd1a3fa4c9340404cad5d27d645a5d30241fe269b0402e0876fefbd3c39b37c583bf54722a9d311ad1dff282eaa1ad214f5c5ac2a589dd67615c6c7b3b2317b97deb7b8f8c979253ea30c99527fe8335658b13aaaa3fcb2326fed205394a5815c89413d6142af83855d10e290dc276ba1316f517ac818871ec11d219f2a66304afab11f0c8aff6060a5cf84a25d0a860e811b3a964a1acbc1df8ccfac09af6068aecfc23d530e19628d00e9eaff6fe998197a54aca262d3a84637ce07e0f418faa195de216e27a2d40332a42850143d4eeb0653dc6facc94e7b9e2f4676c35094e1477602443bc15b93f3e592e714113eb65efcc6cdea339286639e1d64c2355819b4fdb837432aaaa2191695d2a079380a7b47212be48b9c6eba2fb1c63cad7b3490e3773cf009217c8edc39e5c845e646ede6aecdaba533160979107749805eca10c72aacb0b74763095f126149e28082cd2d79676d5d3a4caf8d20232f0be93089d20816c14fe86541af155eb285c2461db624c1611fae4813fecab923c83c6e8d5c1cfca1617b39dec4e9c149")
	//b3, _ := hex.DecodeString("01000005490000044c59609002124419999ac700ce21bc94ee46fce7445cc5bee82eafd73999939f1455bb88f221de1bd2386d97fd640daa796cbd9734054800781c77e2474e81fdfae0c9225757a05c968cab35db49d7e305bed2da00170098425d06c221340595ef93063f63500c5e5d8db70facc4f3c36e6da056c68356697294d2491c83253ce0ed597d0e8d824bf107190b932ac5930edf2030e0f53ecfa66aafff610c9e41369fe976006256d20ddd7f81c61163b47c95c53c68ce862eb5149dc00536b4941430665b1d3724a0206a80f6689fb5263a6302b0bbead0597ec9c26d321f54edafd238943c9c4e163061f0ffca4e978fe580a80e47c43fefdf6a548bda8208a9c3ce165b8c803516049e621154dbc32530435425fcd26d6de8cd461654176424996a0d90c8d625f8a3940b7247c38a0afa2fa97b62a798ad50d01b39f8f0983fb52ed7bf6ae3b3163c6078aaf7fcf5e73b675e43ccaf40e3a428e8ceb8879e2bfbd7d52a62bfd58a608562ae9769ddc06871326e7664436c4fb0135c1f1e3edb3a88fc91eb7bdcf5affd7be73240d644253ba1aa7a4a65e8a655d2d7ae269219819bed8cac4f780c6ef184cdf0c91019cd51acdf0c0feb67b7babc8a2759172be0477e0946e06565d13cfd0f94d352a43d63901c44b4c21e599e4325963bb4b6a76f02219da313d51821a47d52c2922a9b2fdbd22fec7f505e20e15d6494752f94c47d484ed80de631d1519381c0d99272fd2f10c95aaa6e653e15b32bdda0590663650a818040cfbcfb0c13dd0df6756c9b0db0bcfe3834b3d0df8e9f7cb7a485f3af67c810b31d0457b27d5e3f40c076871f87b25954cc33e1ab3fb54777fdb3041b8b77172c77a9c126ea6fc446a02617c2bee0b8c3b1acb52f6e3b9edc405d9204bb3911d515bb7e0407fbe9db73b44d41ea738ed2e797c0d559d9c2be470860f636d95c7167782a743f5013cd0d64f600f398abe3213e4bbc28b6a9ff04a290abdf69a0ba7d155fdbe02fdf53bc2bba0091dc3d102a0a6e36ccb4393462491c814b6c8dcb72a3a45bb3f844ccc77dd9524a2d6e12e8951e19fbba95dceee2b77e2df9fba683df800f83bf666eb9e8252b2a858bc02271939dbca2e28620629f4ca14ac47eeb88b719b56ddd2c26719471e1201ecaf784f797d86d641a97423d3172879d2d69491f975855858a7ce8c2928cc6aa5b29127a0b405b01c26a422b8b4afa79cc9eebebc35d05051bf56a0e6f318d07d64b398294f03bfaf9000712184dd861cdf25375e171d02fcb7ab884e5b601b2d17fcab2e9dabb990e09c1772bec1e8514d5af21f3e0304da84e64f31f5413a26280099d7c6d8c1056e163a720a7402228f617b6689a4193b004d040a2e3a8b2731ea685a7618d0fede6f447a7113f5454762a2bf6559c3a0b4fcf022e8e23ec500e9937c08d2fc8836a46f9d0edeaf4234dad791e839cd5e878266da352b6ae7ccce7b6955835aca1bd0cab88c97dbc030a15a89620b2ca3b6b0731c0312ad97349536f6a88cb553bd9ac7557f8cc11f6dc0bb0ce24f8")
	//b4, _ := hex.DecodeString("010000054a0000044c25e57b8cffb54f44138df8b803a65a52e7a3946c1d0a0d660574833b5397863a92b72d2e91ae3023f44a545ad79556fb12a720974f4e2164f55ee6e05dea41644961e5dfedceb70daf76c879d16f64639b01a197fb2b8973e22b7a2ad60ad5de27e27423a0e983d20d62f2bc949d7fc282713934464fff07a60ec1ed786fff8c23406f686b691f6717c2db033a502fe92a0681dcb11559a5ac9e5b7b5d305345e14b367f93776c02720187c8d0525706e33cc559c062837c24085cab73b951c0823c138d6a34e39c3e24c91397714da88a4f50ecd05ba52835895e29974011c582f0743501e3d3a991713710ecc7eae2d7aaf0c04f2776b758f313425990f5ea7ebc4b637e415ffa24c5e5ee71e9f8f8046aef468f81329bb750cb402c9b31b96740ff7bebd4947f2856fb549d6b29f9072b41d4df84c472a9b316cd02f62fe16612e489db590ff0b267d37e657e861b319a7c2fe40facdaebd6f2fc9c2cca0d142d63a86471196cbbcf03e2d47af462550fd603fb7ae956c1ca613ce5d8501c4a3f983218594fe42ef0a42644df5d72cbe1a9b8d45287d64dd54d0c6fff30886421c54c353813561e9921eb2896d9f42cec0d32c5732f9c9bc70ce927c62aa8769a3fbce9ad990a3268e194eab651ac7354e13ff83a37b93b72fea84a6f8a023059cd0f74cde6aa1975bfdf2283f01e08b9b324f56f33943433d5c6c1f63fa8237c92fa474f944899dfcf05b02cd5d495f8971febfc9df12836a3b2800db88668d7e277dcfe3030fb9a768b114a755d32c64f790a19d296d38d0b1012c5c487d38b50e175bfb0db72567dc2c9f54dcccc15beb749d417754d811e1faed7f0d64d6d19b7d35f90f2e10450f016371cdc9026447fdd6c58e1bd42c94a265c7b55fe56d063df60d1d34195a2db6e472acfb9d78f93bf0358fcf15ef2201dd019217136259bfdb0e673530bc8a05af7b70514cd3e7a2e6242c33ab2c052eeb2f31f6860e43b0ed46b1e958f3e2ed7c3f424d47aa87a2a34d57b0a8401100d142b4e964c04f250e0429f28a70d188fae7b791504b2a11e91081d05f46712dde9dfe0c571c24aa0d25ebb7f48c0fca9d0147a8e996fcedb5663d0bae40c986eed0a01b3948da028be81d4f1f9eab1d7a0150acc99d1773c116f04b8f607676f0a9551c66b697d590a7a2bcdec1f2b4d19d982b668e653b30fd9e1fb9190f48178dac188ea3e6997ab46ea502c80e29024516b5a9798ac6da3da686ddfc0bdb90974dbd4d4c949a90076b8312f19bf7bdda936e1cf19d2afbdce2dd4d15e87f9a6a85c2080be080625ccfeb7657eec358a55e6970358c39acdf19b017014fadc70065feeb697363366f258ca92a1a7b62e2d2cbe23d57b2b946943dba78fefd84a0bb2a7fadf882a49f353f376ec949552b53757ab1b8933d27a53deefed347a1993d60f98921dbc37ec6369573e43dd1e017a868fc7c041b5f37894f7a9656da65177a31ff73899afb3004e8f29a5d471bab5beade5ee7a775b36ed235c46d0e8bea394a77b0b63810b64372bc8a6")
	//b5, _ := hex.DecodeString("01000005eb0000044c8b74093936e014d0de98bf8ccb923e48b2b8d62b05faf336e888a785e6afd4bc26b00e409b1ad3076a4902d9e665143d0dccc5d6482de4d27dbfb62083ff68f1d1fdf5af53c1825639dd7acf2873348fd84e242b66603841a7243985fd7816adf3394d6254113993abe75f2c69701a482a7b4f2e1292d8262d88ace6de79053073d774b861312103be0cd060364f6b6530ea164b8981fece61e2457f36f14f30651748bb607ed60ef4922fde72e5b0934af6859143c04f37a71783cbb29eaf439f3f664a6164c68bf24d82bcc775defc0886208bb69828e55ff67dbdf884a2dd8cb6a01aa8b402af074286d919fdbed917a1a7ca9671a61225a3cea81e295c53c1b7100694e3698d10f7a5ad5eea8340e517de1b54e7a15f6b12ac2d8d3161b7ad1346a97724497315281291d663670a9e734b252faa902d7b80e8be5dfdca93acd750f943f895f9073100d641cf8d5da017438869197ccdd66ba56e5a6c97967d0cde62decce5268ba8e2dfdf9b7a5e030135c47a74ddd16a25d7f7c3bb8909d5f1d6d81ec55715f80e49f6d40ed2eeec0f54dbcc7e94882250702a3e41c1ab14bccb435def4f86e6aeabe8593de56752303967c932cc9b1238c6d1343e33b61b68d7a670bcd3d8037ad5ff237931687044a661d8c82ae71ac60f4417be25b4183d68862bea676ce89fdc4672e45fabc73568bbf3876051affb6fe450c42d7fa28bee6a8f0167f23b0dba96dda201e4c52ac34e119a9c95d1ffe2723dc81f35a82db89dad1ab895377ea423eed9dcbabb173ed38f2c58dbb6043714c0b8c0b96f8b1e15ac4db7c4b63f06354ce79111a4f31daa528a315c524e3a813ef6a4bd27904357e4379ced945d55a45f435e177af58b92606bd40f9708e34617aec83f545dae11d8d1bcfd78f26d9c77842af57d9d39c9661e2581db278be079426a6550228f493a46089680ae88fface2e2cc6de431885d0f44280176179e11e20ff72ed93e99bd5ae7c2f3173d7d0327e362b396d927fe645f7993e65067f1df0b1c80b1f5f94e49b7efc85c028ccbbebd01043443bf40da0b8a330ab9a0b849773dfcd53e6c1201644fd7bf5c7bfb43cf8a5886fe2ebfd19bcea26b678402b0c2bed91aedeed9500de9ccda25db17c16f32f4bc6082362c21bea8b9adc9c4c8ab089b6bb15d9c35ed3b702c305aea43c61fd70522e6e19f0d2fb6658e873da7039290a45355f68b42d80528656f4c98ff4dafd55b040b3b6880c3ea7208e3f87077032641ae7f679793d605a12df258abd02f2238b67034d9785b570f13fb107cd4ee54cef7f6e75c7b4e5711ac8d59d630e8586a2f7afd65c796ad58d9dfa35a0ba2f315867536beaf66323495cff886af5f26a6570a0007160e5dbaeb4293be169aeaa9fbe578663cfb5379c71d7e5d8bb48e828cd20fbfb6b9e5eea18a5f275d5334bbe142c86b158003a52110bb1d46d05c879c7f23b1960f2f0bfd3fcbdece8e807e0119a95ba53bfdd0635936784540e3bb5b9effb4085301735f5175ddc4e195d523e03e80b5cc5a34fe")
	b1, _ := hex.DecodeString("010000006f0000012607c881e3ebe74cdc2568b5239a6bc6da59268cfdef878ee29f1a337c4333ff402f4fb8a81c8b0c92c58f9b0499cf3910dba592632c4de375925047b0a1c7812d4f7f1d7ede3fa24174d3b210c1c367fc0ecb5bab4d03bc8dcf699d8929ae5959aeaa0e3c512db3d95741e56a74b649af74487a1cfbbd36aa1d15d30d0d0cf162517fda36a37375f04c76ebb97149e62a027c63e4e179223a1fd1d5a96fb05c6a27e623472fd4d1ee68eb5f044789917527738ba56d28df9aaa9b746e3413ab1c98076a8adb43907ecb542580fd915740d480ef6799955433751c9592025a6f631b091186572b78ec1a50a4b11d1e6b212df703166a4c7d97fcddc66ba75df83af384c5b5b46864fed77a672607500b9e6b032d26073a1a204ec2acfbd2c41980977b2ac382b7")
	//b2, _ := hex.DecodeString("010000000c000000abfdd0b7c6ed32155111c4734d64d14b472667cdc727caa31ac81265a57f5d31c58b690a3323e895dfad269be39427093eff773b6be8076dd944a7a8491fa0d141a14e26b630d95960017ca4a5457d3e4d38ab81437bc810c6dcda714854394e396a57a619ff742cac2f6b468d26c95daa36eae9fd9caee5eae2e1de9ef761d8493eead9ce685e1d481377aee1b85ee497297bcfb979e2d997c4e0dad80272c986a2703945055b620cf8f648")
	b3, _ := hex.DecodeString("010000007100000126ed1e34edb33e7ac0af36cc82705b6921c225910a676dbddac83f573dc3bb5ae71956c430f66594b1d030b87faf585c9b5380d47890b0e086db7e2d4a4685c85fe87eef81281e21f3c8036168e66c35bb16a5cfc2a2e717af475f7bc2333b6ff3e1621ac35d7d7ca657b4fc2178b4a3a2f378abac88a954c95f64fe87f4d548d6096603e1da16753ad79dcf934719d44cb0327318efbdef0ba0164ab0dbad6fd68cf8a5b5ee2709775b0246479d3a8bb72125d426ef22fd9840fdb49fce90f90903c1c4ae51fc789b42282a4682e65aeb9f0dc1bcf898ea3a471d23c7db65d22de748667e3eb6a306e0e49dd1bea2d46605a54e24267f86abafd2469075a751ee1de9c2504565ce062c4b95928ad196a6ee9fbe5abf00dcfa7f2567d7b4e0a59a2f6a5a7ee773")
	b4, _ := hex.DecodeString("0100000072000001269b892cb821b06358570276ab860974fdc25bf52db0e375b5dea4b178c8c177384eb7f1c2412fda7842d090c1af2df869a30bf4745462ed7e5eed3f1a35ce25a818247668267fe4aaf447cc14b5283698831b046a9fc892b73b8345027c01ca4d3902ee6145da91dc39e2f7e28813ae829dea4d03e82f6cadd86fe09a41b3e315691b0b2cca5c6567e278642c08c3746d5073ade8986e1fce13717c33e13d090247f143b3aa087ea1f982eb2d259dc819f63b46a3d35a192246608f073d26766592155d8a1d036258d7954fe5df1c644480330f8adf4328898537bbcef40457ce6bddc1ae5af068927ef0fef5958f45267e4162948fc7eefc49a9c0232fd559296bedb34bf07a8813d0dd0bca688e369e55a16d12931aaccef7514be53502e333d3a7ec81f58e")
	b5, _ := hex.DecodeString("010000007e000001264c8f10b9eb156aaebfe1d2b8d5c5dc09a2da95a8cd79b6689bc55bf03ce9d30094d023f6854ee9af11fbfb5bbe130a48ada0b263f6e5e49bab18ba71cab507b8f3e0ccb1b559cd54a107bed813d586d7077c6cf520f54e3b46a02bec013fba229497fa3aa0bbcf0fb024495e13a7cf8e6e0dd0e6ab32d97ea24cbdf1f0d7493bd89fef8d64a6baac7e89ffbcc316b51727137b994e3cb5de7aa5835acbac6ad2767ca2902c5b0374948143498c6af8b87e74916cab5ef4eab0ddf0243654922e025a790f700896b7d5a09bbe86bcaea7ab455e1778723929ab173dbb6bdf619b86d2c2deffe1a2c198befb8831464bb328e459b6ec43892faa04871ca130be9613c9beda39357a3761962d0d1d256cbbd573fc7306ce53094058ec93318ed00bde749e27ac2c")
	datas := [][]byte{
		b1,
		nil,
		b3,
		b4,
		b5,
	}

	for i, d := range datas {
		g, err := decoder.decode(uint32(i+1), d)
		if err != nil {
			t.Error(err)
		}
		if g != nil && g.Recovered {
			for i, b := range g.DataRecv {
				if !b {
					m := g.Datas[i]
					if len(m) <= msg.MSG_HEADER_SIZE {
						t.Log("fec recovered len(m) <= msg.MSG_HEADER_SIZE")
						continue
					}
					seq := binary.BigEndian.Uint32(m[msg.MSG_SEQ_BEGIN:msg.MSG_SEQ_END])
					l := binary.BigEndian.Uint32(m[msg.MSG_LEN_BEGIN:msg.MSG_LEN_END])
					t.Logf("fec recovered seq %d l %d len %d\n%x\n", seq, l, len(m), m)
				}
			}
		}
	}

}
